name: Update Contributors Information

on:
  workflow_dispatch: {}
  schedule:
    - cron: "30 1 * * 6"
  push:
    branches: [main]

jobs:
  update-contributors:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if update needed
        id: check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          CURRENT=$(perl -ne 'print $1 if /<!--CONTRIBUTOR COUNT START-->\s*(\d+)/' COMMUNITY.md)
          
          ACTUAL=$(gh api "/repos/$GITHUB_REPOSITORY/contributors?per_page=100" | \
            jq '[.[] | select(.type != "Bot" and (.login | test("\\[bot\\]$") | not) and (.login | test("-bot$") | not))] | length')
          
          echo "Current: $CURRENT, Actual: $ACTUAL"
          
          if [ "$ACTUAL" != "$CURRENT" ]; then
            echo "needs_update=true" >> $GITHUB_OUTPUT
            echo "count=$ACTUAL" >> $GITHUB_OUTPUT
          else
            echo "needs_update=false" >> $GITHUB_OUTPUT
          fi

      - name: Update contributor list
        if: steps.check.outputs.needs_update == 'true'
        uses: akhilmhdh/contributors-readme-action@v2.3.10
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          readme_path: COMMUNITY.md
          use_username: false
          commit_message: "update contributors information"

      - name: Update contributor count
        if: steps.check.outputs.needs_update == 'true'
        run: |
          COUNT="${{ steps.check.outputs.count }}"
          perl -i -pe 's/(<!--CONTRIBUTOR COUNT START-->).*?(<!--CONTRIBUTOR COUNT END-->)/$1 '"$COUNT"' $2/' COMMUNITY.md

      - name: Create Pull Request
        if: steps.check.outputs.needs_update == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "docs: update contributors (count: ${{ steps.check.outputs.count }})"
          title: "docs: update contributors information"
          body: |
            Automated contributor update - new contributor detected!
            
            Updated count: ${{ steps.check.outputs.count }}
          branch: update-contributors
          delete-branch: true
          labels: documentation
