name: Update Contributors Information

on:
  workflow_dispatch: {}
  schedule:
    - cron: "30 1 * * 6"  # Weekly on Saturdays
  push:
    branches: [main]

jobs:
  update-contributors:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if update needed
        id: check_changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          OWNER=$(echo $GITHUB_REPOSITORY | cut -d'/' -f1)
          REPO=$(echo $GITHUB_REPOSITORY | cut -d'/' -f2)
          
          # Get current contributors from GitHub API (excluding bots)
          CURRENT=$(gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/repos/$OWNER/$REPO/contributors?per_page=100" | \
            jq -r '[.[] | select(.type != "Bot" and (.login | test("\\[bot\\]$") | not) and (.login | test("-bot$") | not)) | .login] | sort | join(",")')
          
          EXISTING=$(grep -oP '(?<=github.com/)[^"]+(?=">)' COMMUNITY.md | \
            grep -v "^$" | sort | uniq | tr '\n' ',' | sed 's/,$//')
          
          echo "Current contributors: $CURRENT"
          echo "Existing contributors: $EXISTING"
          
          # Compare and set output
          if [ "$CURRENT" = "$EXISTING" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "âœ… No new contributors found. Skipping update."
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ðŸŽ‰ New contributors detected! Running update..."
          fi

      - name: Update contributor list
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: akhilmhdh/contributors-readme-action@v2.3.10
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          readme_path: COMMUNITY.md
          use_username: false
          commit_message: "docs: update contributors list"
          pr_title_on_protected: "docs: update contributors list"
          committer_username: "github-actions[bot]"
          committer_email: "github-actions[bot]@users.noreply.github.com"
