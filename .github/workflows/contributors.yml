name: Update Contributors Information

on:
  workflow_dispatch: {}
  schedule:
    - cron: "30 1 * * 6"
  push:
    branches: [main]

jobs:
  update-contributors:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get contributors and check if update needed
        id: check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get current count
          CURRENT=$(perl -ne 'print $1 if /<!--CONTRIBUTOR COUNT START-->\s*(\d+)/' COMMUNITY.md)
          
          # Get contributors (excluding bots)
          CONTRIBUTORS=$(gh api "/repos/$GITHUB_REPOSITORY/contributors?per_page=100" | \
            jq -r '[.[] | select(.type != "Bot" and (.login | test("\\[bot\\]$") | not) and (.login | test("-bot$") | not))] | 
            map("<td align=\"center\">\n                <a href=\"\(.html_url)\">\n                    <img src=\"\(.avatar_url)\" width=\"100;\" alt=\"\(.login)\"/>\n                    <br />\n                    <sub><b>\(.login)</b></sub>\n                </a>\n            </td>") | join("\n            ")')
          
          ACTUAL=$(echo "$CONTRIBUTORS" | grep -c "<td align=" || echo 0)
          
          echo "Current: $CURRENT, Actual: $ACTUAL"
          
          if [ "$ACTUAL" != "$CURRENT" ]; then
            echo "needs_update=true" >> $GITHUB_OUTPUT
            echo "count=$ACTUAL" >> $GITHUB_OUTPUT
            echo "contributors<<EOF" >> $GITHUB_OUTPUT
            echo "$CONTRIBUTORS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "needs_update=false" >> $GITHUB_OUTPUT
          fi

      - name: Update COMMUNITY.md
        if: steps.check.outputs.needs_update == 'true'
        run: |
          COUNT="${{ steps.check.outputs.count }}"
          CONTRIBUTORS="${{ steps.check.outputs.contributors }}"
          
          # Update count
          perl -i -pe 's/(<!--CONTRIBUTOR COUNT START-->).*?(<!--CONTRIBUTOR COUNT END-->)/$1 '"$COUNT"' $2/' COMMUNITY.md
          
          # Update contributors table
          perl -i -0777 -pe 's|(<!-- readme: contributors -start -->).*?(<!-- readme: contributors -end -->)|$1\n<table>\n\t<tbody>\n\t\t<tr>\n            '"$CONTRIBUTORS"'\n\t\t</tr>\n\t<tbody>\n</table>\n$2|s' COMMUNITY.md

      - name: Create Pull Request
        if: steps.check.outputs.needs_update == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "docs: update contributors (count: ${{ steps.check.outputs.count }})"
          title: "docs: update contributors information"
          body: |
            ðŸŽ‰ New contributor detected!
            
            **Updated count:** ${{ steps.check.outputs.count }}
          branch: update-contributors
          delete-branch: true
          labels: documentation
